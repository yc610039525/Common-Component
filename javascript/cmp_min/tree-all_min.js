Ext.ns("Frame.tree");Frame.tree.AsynTreeLoader=Ext.extend(Ext.tree.TreeLoader,{checkVisible:undefined,paramOrder:["cuid","text","leaf","parentTreeNode","checked","boName","params","treeParams","treeName","system","queryParams"],paramsAsHash:false,directFn:function(){var a=arguments[arguments.length-2];var c=arguments[arguments.length-1];var d={};for(var b=0;b<a.paramOrder.length;b++){d[a.paramOrder[b]]=arguments[b+1]}TreePanelAction.loadData(d,function(e){c.createDelegate(a,[e,{status:true}],0)()})},createNode:function(a){if(!Ext.isEmpty(a.icon)){a.icon=ctx+"/"+a.icon}if(this.checkVisible===true){if(a.checked===true){a.checked=true}else{a.checked=false}}else{if(this.checkVisible===false){a.checked=undefined}else{if(a.checked===true){a.checked=true}else{if(a.checked===false){a.checked=false}else{a.checked=undefined}}}}return Frame.tree.AsynTreeLoader.superclass.createNode.call(this,a)},requestData:function(d,e,c){if(this.fireEvent("beforeload",this,d,e)!==false){if(Ext.isEmpty(d.attributes.boName)){d.attributes.boName=this.boName}else{this.boName=d.attributes.boName}for(var b=0;b<this.paramOrder.length;b++){this.baseParams[this.paramOrder[b]]=d.attributes[this.paramOrder[b]]}var a=this.getParams(d);a.push(this);a.push(this.processDirectResponse.createDelegate(this,[{callback:e,node:d,scope:c}],true));this.directFn.apply(window,a)}},processResponse:function(d,c,j,k){var l=d.responseText;try{var a=d.responseData||Ext.decode(l);c.beginUpdate();for(var f=0,g=a.length;f<g;f++){var b=this.createNode(a[f]);if(b){b.index=Ext.isEmpty(c)?f:c.childNodes.length;c.appendChild(b)}}c.endUpdate();this.runCallback(j,k||c,[c])}catch(h){this.handleFailure(d)}},doPreload:function(d){if(d.attributes.children){if(d.childNodes.length<1){var c=d.attributes.children;d.beginUpdate();for(var b=0,a=c.length;b<a;b++){var e=d.appendChild(this.createNode(c[b]));if(this.preloadChildren){e.index=Ext.isEmpty(d)?b:d.childNodes.length;this.doPreload(e)}}d.endUpdate()}return true}return false}});Frame.tree.AsynTreePanel=Ext.extend(Ext.tree.TreePanel,{checkVisible:undefined,initComponent:function(){this.loader=new Frame.tree.AsynTreeLoader({clearOnLoad:this.clearOnLoad,checkVisible:this.checkVisible});if(this.header!==false){this.initTreeTools()}Frame.tree.AsynTreePanel.superclass.initComponent.call(this);this.on("dblclick",function(a,b){if(Ext.isDefined(a.attributes.cuid)&&a.attributes.cuid.indexOf("moreNodeBtn")!=-1){this.expandMoreNode(a,b)}else{this.fireEvent("treeNodeClick",a,b)}},this)},expandMoreNode:function(a){if(a.parentNode.attributes){a.parentNode.attributs={params:{}}}else{if(a.parentNode.attributes.params){a.parentNode.attributes.params={}}}a.parentNode.attributes.params.pageNumber=a.attributes.params.pageNumber;a.parentNode.attributes.params.pageCount=a.attributes.params.pageCount;a.parentNode.attributes.params.redirectTemplateIds=a.attributes.params.redirectTemplateIds;a.getOwnerTree().loader.load(a.parentNode,function(){a.parentNode.attributes.params.redirectTemplateIds=null;a.remove(true)})},initTreeTools:function(){this.tools=[{id:"refresh",scope:this,handler:function(){var a=this.getSelectionModel().getSelectedNode();if(a){this.reloadNode(a)}else{this.reloadNode(this.getRootNode())}}},{id:"plus",scope:this,handler:function(){this.expandAll()}},{id:"minus",scope:this,handler:function(){this.collapseAll()}}]},reloadNode:function(a){a.removeAll();a.attributes.params.pageNumber=null;if(a.attributes.params.pageCount!=-1){a.attributes.params.pageCount=null}a.getOwnerTree().loader.load(a,function(){a.expand()})}});Ext.reg("asyntreepanel",Frame.tree.AsynTreePanel);Frame.tree.AsynTreeGridLoader=Ext.extend(Frame.tree.AsynTreeLoader,{createNode:function(a){if(!a.uiProvider){a.uiProvider=Ext.ux.tree.TreeGridNodeUI}Ext.apply(a,a.data);return Frame.tree.AsynTreeGridLoader.superclass.createNode.call(this,a)}});Frame.tree.AsynTreeGridPanel=Ext.extend(Ext.ux.tree.TreeGrid,{checkVisible:undefined,autoLoad:false,singleSelect:false,enableSort:false,initComponent:function(){if(this.autoLoad==true){this.autoLoad=false;this._autoLoad=true}else{this._autoLoad=false}var a=this;if(this.singleSelect){this.selModel=new Ext.tree.DefaultSelectionModel({listeners:{selectionchange:function(c,e){var b=a.getChecked();for(var d=0;d<b.length;d++){b[d].getUI().toggleCheck(false)}e.getUI().toggleCheck(true)}}})}else{this.selModel=new Ext.tree.MultiSelectionModel({onNodeClick:function(d,f){var g=false;for(var b=0;b<d.parentNode.childNodes.length;b++){var h=d.parentNode.childNodes[b];if(h.isSelected()){g=true}}var c=undefined;if(g){c=d.parentNode.last}else{d.parentNode.last=undefined}if(f.shiftKey&&!this.singleSelect&&Ext.isDefined(c)){a.selectRange(c,d,this.ctrlKey)}else{if(f.ctrlKey&&this.isSelected(d)){this.unselect(d)}else{this.select(d,f,f.ctrlKey);d.parentNode.last=d}}},listeners:{selectionchange:function(e,d){var c=a.getChecked();for(var f=0;f<c.length;f++){if(c[f].getUI().isChecked()){var b=c[f].getUI().checkbox;if(b){b.checked=false;var g=c[f].getUI().checkbox.checked;b.defaultChecked=g;c[f].getUI().node.attributes.checked=g}}}for(var f=0;f<d.length;f++){if(!d[f].getUI().isChecked()){var b=d[f].getUI().checkbox;if(b){b.checked=true;var g=d[f].getUI().checkbox.checked;b.defaultChecked=g;d[f].getUI().node.attributes.checked=g}}}}}})}if(!this.root){this.root=new Ext.tree.AsyncTreeNode({text:"Root"})}else{if(Ext.isObject(this.root)){this.root=new Ext.tree.AsyncTreeNode(this.root)}}this.loader=new Frame.tree.AsynTreeGridLoader({clearOnLoad:this.clearOnLoad,checkVisible:this.checkVisible});if(!this.columns){this.columns=[{dataIndex:"text",header:"名称",width:150}]}if(this.header!==false){this.initTreeTools()}Frame.tree.AsynTreeGridPanel.superclass.initComponent.call(this);this.on("beforeload",function(b){if(this.autoLoad===false){this.autoLoad=true;return false}});this.on("dblclick",function(b,c){if(Ext.isDefined(b.attributes.cuid)&&b.attributes.cuid.indexOf("moreNodeBtn")!=-1){this.expandMoreNode(b,c)}else{this.fireEvent("treeNodeClick",b,c)}},this);this.on("checkchange",function(d,c){if(c){d.getUI().focus();d.getUI().addClass("x-tree-selected");d.parentNode.last=d;var e=this.selModel.selNodes;var b=e.indexOf(d);if(b==-1){this.selModel.selNodes.push(d)}this.selModel.selMap[d.id]=d}else{d.getUI().addClass("x-tree-selected");d.getUI().removeClass("x-tree-selected");d.parentNode.last=undefined;var e=this.selModel.selNodes;var b=e.indexOf(d);if(b!=-1){this.selModel.selNodes.splice(b,1)}delete this.selModel.selMap[d.id]}},this);if(this._autoLoad==true){this.on("afterrender",function(b){b.getRootNode().expand()},this)}},selectRange:function(b,a,d){if(!d){this.selModel.clearSelections()}if(b.index<=a.index){var c=b;while(c!=null&&c.previousSibling!=a){this.selModel.select(c,null,true);c=c.nextSibling}}else{var c=a;while(c!=null&&c.previousSibling!=b){this.selModel.select(c,null,true);c=c.nextSibling}}},expandMoreNode:function(a){if(a.parentNode.attributes){a.parentNode.attributs={params:{}}}else{if(a.parentNode.attributes.params){a.parentNode.attributes.params={}}}a.parentNode.attributes.params.pageNumber=a.attributes.params.pageNumber;a.parentNode.attributes.params.pageCount=a.attributes.params.pageCount;a.parentNode.attributes.params.redirectTemplateIds=a.attributes.params.redirectTemplateIds;a.getOwnerTree().loader.load(a.parentNode,function(){a.parentNode.attributes.params.redirectTemplateIds=null;a.remove(true)})},initTreeTools:function(){this.tools=[{id:"refresh",scope:this,handler:function(){var a=this.getSelectionModel().getSelectedNode();if(a){this.reloadNode(a)}else{this.reloadNode(this.getRootNode())}}},{id:"plus",scope:this,handler:function(){this.expandAll()}},{id:"minus",scope:this,handler:function(){this.collapseAll()}}]},reloadNode:function(a){a.removeAll(true);a.attributes.params.pageNumber=null;if(a.attributes.params.pageCount!=-1){a.attributes.params.pageCount=null}if(a.isExpanded()){a.getOwnerTree().loader.load(a)}else{a.expand()}}});